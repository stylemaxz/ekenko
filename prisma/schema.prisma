generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  phone               String
  role                Role
  avatar              String?
  portfolioSize       Int            @default(0)
  username            String?        @unique
  password            String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  assignedLocationIds String[]
  activityLogs        ActivityLog[]
  leaveRequests       LeaveRequest[]
  tasks               Task[]
  visits              Visit[]
  reservations        Reservation[]
  maintenanceTasks    MaintenanceTask[]
  // R&D relations
  samplesSent         Sample[]       @relation("SampleSender")
  feedbacksCollected  SampleFeedback[] @relation("FeedbackCollector")
  rndTasksAssigned    RndTask[]      @relation("RndTaskAssignee")
  rndTasksCreated     RndTask[]      @relation("RndTaskCreator")
  taskComments        TaskComment[]  @relation("CommentAuthor")
}

model Company {
  id        String        @id @default(uuid())
  name      String
  taxId     String?
  logo      String?
  grade     CompanyGrade
  status    CompanyStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  locations Location[]
  tasks     Task[]
  serviceContracts ServiceContract[]
  reservations Reservation[]
  projects  Project[]
}

model Location {
  id                  String          @id @default(uuid())
  companyId           String
  code                String?
  status              LocationStatus?
  name                String
  address             String
  postalCode          String?
  district            String?
  province            String?
  region              String?
  googleMapLink       String?
  lat                 Float
  lng                 Float
  officialName        String?
  customerType        CustomerType?
  ownerName           String?
  ownerPhone          String?
  documents           String[]
  shippingAddress     String?
  receiverName        String?
  receiverPhone       String?
  creditTerm          Int?
  vatType             VatType?
  promotionNotes      String?
  notes               String?
  statusNote          String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  createdBy           String?
  assignedEmployeeIds String[]
  contacts            ContactPerson[]
  company             Company         @relation(fields: [companyId], references: [id])
  tasks               Task[]
  visits              Visit[]
  assets              Asset[]
  projects            Project[]
}

model ContactPerson {
  id         String   @id @default(uuid())
  locationId String
  name       String
  role       String
  phone      String
  lineId     String?
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

model Visit {
  id              String           @id @default(uuid())
  employeeId      String
  locationId      String
  checkInTime     DateTime
  checkOutTime    DateTime?
  objectives      String[]
  notes           String?
  images          String[]
  metOwner        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  employee        Employee         @relation(fields: [employeeId], references: [id])
  location        Location         @relation(fields: [locationId], references: [id])
  sampleFeedbacks SampleFeedback[]
}

model Task {
  id             String       @id @default(uuid())
  title          String
  description    String?
  objectives     String[]
  assigneeId     String
  customerId     String?
  locationId     String?
  dueDate        DateTime
  priority       TaskPriority
  status         TaskStatus
  completionNote String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  assignee       Employee     @relation(fields: [assigneeId], references: [id])
  company        Company?     @relation(fields: [customerId], references: [id])
  location       Location?    @relation(fields: [locationId], references: [id])
}

model LeaveRequest {
  id         String      @id @default(uuid())
  employeeId String
  type       LeaveType
  startDate  DateTime
  endDate    DateTime
  days       Float
  reason     String
  isPaid     Boolean     @default(true)
  status     LeaveStatus
  reviewNote String?
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime    @default(now())
  employee   Employee    @relation(fields: [employeeId], references: [id])
}

model ActivityLog {
  id           String   @id @default(uuid())
  type         String
  employeeId   String
  employeeName String
  description  String
  metadata     Json?
  timestamp    DateTime @default(now())
  employee     Employee @relation(fields: [employeeId], references: [id])
}

enum Role {
  sales
  manager
  maintenance
  rnd
}

enum CompanyGrade {
  A
  B
  C
}

enum CompanyStatus {
  existing
  lead
  inactive
  closed
  terminate
  active
}

enum LocationStatus {
  existing
  lead
  inactive
  closed
  terminate
  active
}

enum CustomerType {
  individual
  juristic
}

enum VatType {
  ex_vat  @map("ex-vat")
  in_vat  @map("in-vat")
  non_vat @map("non-vat")
}

enum LeaveType {
  sick
  personal
  vacation
  other
}

enum LeaveStatus {
  pending
  approved
  rejected
}

enum TaskStatus {
  pending
  in_progress
  completed
  overdue
}

enum TaskPriority {
  low
  medium
  high
}

// --- Asset Management Models ---

model Asset {
  id                String             @id @default(uuid())
  serialNumber      String             @unique
  modelName         String
  status            AssetStatus        @default(AVAILABLE)
  condition         AssetCondition     @default(NEW)
  purchaseDate      DateTime?
  cost              Float?
  currentLocationId String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  location          Location?          @relation(fields: [currentLocationId], references: [id])
  contractItems     ContractItem[]
  transactions      AssetTransaction[]
  reservations      Reservation[]
  maintenanceTasks  MaintenanceTask[]
}


model ServiceContract {
  id             String           @id @default(uuid())
  contractNumber String           @unique
  customerId     String
  type           ContractType     @default(RENTAL)
  startDate      DateTime
  endDate        DateTime?
  status         ContractStatus   @default(DRAFT)
  isSigned       Boolean          @default(false)
  notes          String?
  price          Float            @default(0.0)
  documentUrl    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  customer       Company          @relation(fields: [customerId], references: [id])
  items          ContractItem[]
}

model ContractItem {
  id                String          @id @default(uuid())
  serviceContractId String
  assetId           String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  serviceContract   ServiceContract @relation(fields: [serviceContractId], references: [id], onDelete: Cascade)
  asset             Asset           @relation(fields: [assetId], references: [id])

  @@unique([serviceContractId, assetId])
}

model AssetTransaction {
  id             String            @id @default(uuid())
  assetId        String
  fromLocationId String?
  toLocationId   String?
  action         TransactionAction
  reason         String?
  performedBy    String?
  images         String[]          @default([])
  performedAt    DateTime          @default(now())

  asset          Asset             @relation(fields: [assetId], references: [id])
}

model Reservation {
  id          String   @id @default(uuid())
  assetId     String
  customerId  String
  reservedBy  String   // Employee ID
  startDate   DateTime
  endDate     DateTime?
  status      ReservationStatus @default(PENDING)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  asset       Asset    @relation(fields: [assetId], references: [id])
  customer    Company  @relation(fields: [customerId], references: [id])
  employee    Employee @relation(fields: [reservedBy], references: [id])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum AssetStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  RESERVED
  DISPOSAL
  LOST
  SPARE
}

enum AssetCondition {
  NEW
  USED
  REFURBISHED
  BROKEN
}

enum ContractType {
  RENTAL
  LOAN
  TRIAL
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
  VOID
  CLOSED
}

enum TransactionAction {
  DELIVERY
  RETURN
  TRANSFER
  MAINTENANCE_IN
  MAINTENANCE_OUT
  ADJUSTMENT
}


model MaintenanceTask {
  id              String              @id @default(uuid())
  assetId         String
  title           String
  description     String
  priority        MaintenancePriority
  status          MaintenanceStatus
  assignedTo      String?
  scheduledDate   DateTime?
  completedDate   DateTime?
  estimatedHours  Float?
  actualHours     Float?
  images          String[]            @default([])
  notes           String?
  totalCost       Float               @default(0.0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  asset           Asset               @relation(fields: [assetId], references: [id])
  assignedEmployee Employee?          @relation(fields: [assignedTo], references: [id])
  partsUsage      TaskPartUsage[]
}

enum MaintenancePriority {
  low
  medium
  high
  urgent
}

enum MaintenanceStatus {
  pending
  assigned
  in_progress
  completed
  cancelled
}

model SparePart {
  id          String   @id @default(uuid())
  name        String
  description String?
  partNumber  String   @unique
  imageUrl    String?
  stock       Int      @default(0)
  minStock    Int      @default(5)
  price       Float    @default(0.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usage       TaskPartUsage[]
}

model TaskPartUsage {
  id          String   @id @default(uuid())
  taskId      String
  partId      String
  quantity    Int      @default(1)
  priceAtTime Float
  createdAt   DateTime @default(now())

  task        MaintenanceTask @relation(fields: [taskId], references: [id])
  part        SparePart       @relation(fields: [partId], references: [id])
}

// --- R&D Project Management Models ---

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  customerId  String
  status      ProjectStatus @default(active)
  startDate   DateTime      @default(now())
  targetDate  DateTime?
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  customer    Company       @relation(fields: [customerId], references: [id])
  products    Product[]
  rndTasks    RndTask[]
  locationId  String?
  location    Location?     @relation(fields: [locationId], references: [id])
}

model Product {
  id             String        @id @default(uuid())
  projectId      String
  name           String
  formula        String?
  specifications String?
  status         ProductStatus @default(development)
  version        Int           @default(1)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  samples        Sample[]
}

model Sample {
  id           String          @id @default(uuid())
  productId    String
  sampleNumber String
  version      Int             @default(1)
  sentDate     DateTime        @default(now())
  dueDate      DateTime
  sentBy       String
  status       SampleStatus    @default(sent)
  notes        String?
  images       String[]        @default([])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  sender       Employee        @relation("SampleSender", fields: [sentBy], references: [id])
  feedback     SampleFeedback?
  followUpTask RndTask?        @relation("SampleFollowUp")
}

model SampleFeedback {
  id               String            @id @default(uuid())
  sampleId         String            @unique
  feedbackBy       String
  visitId          String?
  rating           Int?
  customerReaction CustomerReaction?
  comments         String?
  images           String[]          @default([])
  collectedAt      DateTime          @default(now())

  sample           Sample            @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  collector        Employee          @relation("FeedbackCollector", fields: [feedbackBy], references: [id])
  visit            Visit?            @relation(fields: [visitId], references: [id])
}

model RndTask {
  id             String       @id @default(uuid())
  projectId      String
  sampleId       String?      @unique
  title          String
  description    String?
  taskType       RndTaskType
  assigneeId     String
  createdBy      String
  dueDate        DateTime
  priority       TaskPriority @default(medium)
  status         TaskStatus   @default(pending)
  completionNote String?
  images         String[]     @default([])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  project        Project      @relation(fields: [projectId], references: [id])
  sample         Sample?      @relation("SampleFollowUp", fields: [sampleId], references: [id])
  assignee       Employee     @relation("RndTaskAssignee", fields: [assigneeId], references: [id])
  creator        Employee     @relation("RndTaskCreator", fields: [createdBy], references: [id])
  comments       TaskComment[]
}

model TaskComment {
  id        String   @id @default(uuid())
  rndTaskId String
  authorId  String
  content   String
  images    String[] @default([])
  createdAt DateTime @default(now())

  rndTask   RndTask  @relation(fields: [rndTaskId], references: [id], onDelete: Cascade)
  author    Employee @relation("CommentAuthor", fields: [authorId], references: [id])
}

enum ProjectStatus {
  active
  on_hold
  completed
  cancelled
}

enum ProductStatus {
  development
  sampling
  approved
  production
  discontinued
}

enum SampleStatus {
  sent
  pending_feedback
  feedback_received
  revision_needed
  approved
  rejected
}

enum CustomerReaction {
  very_positive
  positive
  neutral
  negative
  very_negative
}

enum RndTaskType {
  sample_followup
  development
  revision
  testing
  documentation
  general
}
